<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Route Overlay</title>

<style>
*{ box-sizing:border-box; }

html,body{
  margin:0;
  width:100%;
  height:100%;
  background:transparent;
  overflow:hidden;
  font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
}

#wrap{
  width:100vw;
  height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
}

/* 1920x1080 design area */
#mapBox{
  position:relative;
  width:1920px;
  height:1080px;
  transform: scale(var(--s,1));
  transform-origin:center;
  border-radius:18px;
  overflow:hidden;
}

#mapImg{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit:contain;
  user-select:none;
  -webkit-user-drag:none;
}

/* PIN */
#pin{
  position:absolute;
  left:50%;
  top:50%;
  transform:translate(-50%,-50%);
  pointer-events:none;
}

#pin .pingRing{
  position:absolute;
  left:50%;
  top:50%;
  width:22px;
  height:22px;
  transform:translate(-50%,-50%);
  border-radius:999px;
  border:2px solid rgba(46,168,255,.9);
  animation: ping 2.8s ease-out infinite;
}

#pin::after{
  content:"";
  position:absolute;
  left:50%;
  top:50%;
  width:22px;
  height:22px;
  transform:translate(-50%,-50%);
  border-radius:999px;
  border:2px solid rgba(46,168,255,.6);
  animation: ping 2.8s ease-out infinite;
  animation-delay:1.4s;
}

#pinImg{
  position:absolute;
  left:50%;
  top:50%;
  transform:translate(-50%, -58%);
  width:54px;
  height:auto;
  filter: drop-shadow(0 8px 18px rgba(0,0,0,.55));
}

@keyframes ping{
  0%{ transform:translate(-50%,-50%) scale(.6); opacity:.9;}
  70%{ transform:translate(-50%,-50%) scale(2.8); opacity:.2;}
  100%{ transform:translate(-50%,-50%) scale(3.2); opacity:0;}
}
</style>
</head>

<body>

<div id="wrap">
  <div id="mapBox">
    <img id="mapImg" src="https://i.imgur.com/j5upGje.jpeg" alt="map">
    <div id="pin">
      <div class="pingRing"></div>
      <img id="pinImg" src="https://i.imgur.com/CtI20w2.png" alt="pin">
    </div>
  </div>
</div>

<script>
/* =========================
   CONFIG
========================= */

const POS_URL = "https://delicate-mud-07e0.erik-bondesson99.workers.dev/pos";
const OVERLAY_KEY = "slope";
const POLL_MS = 1000;
const SMOOTH = 0.18;

/* CAL with x-5 y-85 */
const CAL = [
  { name:"Dresden", lat:51.054763, lon:13.747020, x:1367, y:536 },
  { name:"Nurnberg", lat:49.445086, lon:11.082028, x:1168, y:717 },
  { name:"Munster", lat:51.957394, lon:7.635755, x:913, y:425 },
  { name:"Hannover", lat:52.383871, lon:9.732742, x:1073, y:378 },
  { name:"Amsterdam", lat:52.371712, lon:4.831078, x:716, y:375 },
  { name:"Bremen", lat:53.087970, lon:8.797499, x:1003, y:292 },
  { name:"Saarbrucken", lat:49.236904, lon:6.987325, x:867, y:739 },
  { name:"Pratteln", lat:47.518277, lon:7.694486, x:919, y:935 },
  { name:"Milano", lat:45.471507, lon:9.178016, x:1030, y:1150 },
  { name:"Lyon", lat:45.756971, lon:4.838215, x:711, y:1121 },
  { name:"Toulouse", lat:43.598646, lon:1.439185, x:458, y:1343 }
];

/* ROUTE */
const ROUTE_COORDS = [1369,554,1358,565,1344,576,1334,589,1320,603,1306,619,1290,630,1273,644];
function buildRoute(flat){
  const pts=[];
  for(let i=0;i<flat.length-1;i+=2){
    pts.push({x:flat[i],y:flat[i+1]});
  }
  return pts;
}
const ROUTE = buildRoute(ROUTE_COORDS);

function snap(x,y){
  let best=ROUTE[0], bestD=Infinity;
  for(const p of ROUTE){
    const dx=x-p.x, dy=y-p.y;
    const d=dx*dx+dy*dy;
    if(d<bestD){bestD=d;best=p;}
  }
  return best;
}

/* ========================= */

const mapBox=document.getElementById("mapBox");
const mapImg=document.getElementById("mapImg");
const pin=document.getElementById("pin");

let imgFit=null;
let smoothX=null;
let smoothY=null;

function updateScale(){
  const s=Math.min(window.innerWidth/1920,window.innerHeight/1080);
  mapBox.style.setProperty("--s",s);
}
window.addEventListener("resize",updateScale);
updateScale();

function updateImgFit(){
  const natW=mapImg.naturalWidth||1920;
  const natH=mapImg.naturalHeight||1080;
  imgFit={natW,natH};
}
mapImg.onload=updateImgFit;

function geoToImg(lat,lon){
  const p=CAL[0];
  return {x:p.x,y:p.y}; // demo position
}

function setPin(x,y){
  if(smoothX==null){smoothX=x;smoothY=y;}
  smoothX+= (x-smoothX)*SMOOTH;
  smoothY+= (y-smoothY)*SMOOTH;
  pin.style.left=smoothX+"px";
  pin.style.top=smoothY+"px";
}

async function tick(){
  try{
    const r=await fetch(POS_URL,{headers:{"X-Overlay-Key":OVERLAY_KEY}});
    const j=await r.json();
    if(!j.lat) return;

    const img=geoToImg(j.lat,j.lon);
    const snapped=snap(img.x,img.y);
    setPin(snapped.x,snapped.y);
  }catch(e){}
}

setInterval(tick,POLL_MS);
</script>

</body>
</html>
